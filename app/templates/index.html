<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GO-CHANTIER — Gestion de projets</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --primary: #22c55e;
      --primary-700: #15803d;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 1200px at 20% -10%, #1f2937 0%, #111827 30%, #0b1220 70%, #020617 100%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.4;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(2, 6, 23, 0.7), rgba(2,6,23,0.35));
      z-index: 10;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: conic-gradient(from 210deg at 50% 50%, #22c55e 0deg, #0ea5e9 120deg, #a78bfa 240deg, #22c55e 360deg);
      box-shadow: 0 0 0 2px rgba(255,255,255,0.06) inset, 0 8px 30px rgba(34,197,94,0.25);
    }
    .brand h1 { font-size: 18px; margin: 0; font-weight: 600; }
    .brand small { color: var(--muted); display: block; font-weight: 400; }

    .toolbar { display: flex; gap: 10px; align-items: center; }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #111827, #0b1220);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover { border-color: #2a3647; }
    .btn:active { transform: translateY(1px); }
    .btn-primary {
      border-color: rgba(34, 197, 94, .35);
      background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(21,128,61,.22));
      color: #d1fae5;
    }
    .btn-danger {
      border-color: rgba(239, 68, 68, .35);
      background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(127,29,29,.22));
      color: #fee2e2;
    }
    .btn-warning {
      border-color: rgba(245, 158, 11, .35);
      background: linear-gradient(180deg, rgba(245,158,11,.22), rgba(120,53,15,.22));
      color: #ffedd5;
    }

    .search {
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      width: 280px;
    }
    .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .grid {
      display: grid; grid-template-columns: 1.2fr 1.8fr; gap: 20px;
    }
    .panel {
      background: linear-gradient(180deg, rgba(17,24,39,.85), rgba(9,13,23,.85));
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: clip;
    }
    .panel h2 { font-size: 16px; margin: 0; padding: 14px 16px; border-bottom: 1px solid var(--border); color: #dbeafe; }
    .panel-body { padding: 14px 16px; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--muted); font-weight: 600; font-size: 12px; letter-spacing: .02em; text-transform: uppercase; }
    tr:hover td { background: rgba(148, 163, 184, .04); }
    .empty { color: var(--muted); font-style: italic; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: rgba(148,163,184,.12); border: 1px solid var(--border); color: #bfdbfe; }

    .detail-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .detail-meta { color: var(--muted); font-size: 14px; }

    .dropzone {
      border: 1px dashed #2a3647;
      background: repeating-linear-gradient(135deg, rgba(148,163,184,.04), rgba(148,163,184,.04) 12px, rgba(148,163,184,.06) 12px, rgba(148,163,184,.06) 24px);
      border-radius: 12px;
      padding: 18px;
      text-align: center;
      color: var(--muted);
      transition: border-color .2s ease, background .2s ease;
    }
    .dropzone.dragover { border-color: var(--primary); background: rgba(34,197,94,.06); color: #bbf7d0; }
    .files { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; margin-top: 12px; }
    .file-item { display: flex; align-items: center; justify-content: space-between; gap: 10px; background: rgba(2,6,23,.55); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
    .file-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .muted { color: var(--muted); }

    .inline-form { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .input, textarea {
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      padding: 10px 12px;
    }
    .input { height: 40px; }
    textarea { min-height: 72px; width: 100%; resize: vertical; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(2,6,23,.55); display: none; align-items: center; justify-content: center; padding: 20px; }
    .modal { width: 100%; max-width: 560px; background: #0b1220; border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .modal header { position: static; background: transparent; border: none; padding: 14px 16px; }
    .modal .panel-body { padding: 16px; }
    .modal footer { padding: 12px 16px 16px; display: flex; justify-content: flex-end; gap: 10px; }

    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
      .files { grid-template-columns: 1fr; }
      .search { width: 100%; }
    }
  </style>
  <meta name="color-scheme" content="dark light" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect rx='12' width='64' height='64' fill='%2322c55e'/%3E%3C/svg%3E" />
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>GO-CHANTIER<small>Suivi de chantier routier</small></h1>
      </div>
    </div>
    <div class="toolbar">
      <input id="search" class="search" type="search" placeholder="Rechercher un projet…" />
      <button id="newProjectBtn" class="btn btn-primary">Nouveau projet</button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="panel" aria-labelledby="projectsTitle">
        <h2 id="projectsTitle">Projets</h2>
        <div class="panel-body" style="padding-top: 6px;">
          <table id="projectsTable" aria-describedby="liste des projets">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Créé le</th>
                <th>Images</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="projectsBody">
              <tr><td colspan="4" class="empty">Aucun projet. Cliquez sur « Nouveau projet » pour commencer.</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel" aria-labelledby="detailTitle">
        <h2 id="detailTitle">Détails du projet</h2>
        <div class="panel-body">
          <div id="emptyState" class="muted">Sélectionnez un projet pour importer des images GeoTIFF et gérer les données.</div>

          <div id="detail" style="display:none;">
            <div class="detail-header">
              <div>
                <div id="projectName" style="font-weight:600; font-size:18px;"></div>
                <div id="projectMeta" class="detail-meta"></div>
              </div>
              <div style="display:flex; gap:8px;">
                <button id="renameProjectBtn" class="btn">Renommer</button>
                <button id="deleteProjectBtn" class="btn btn-danger">Supprimer</button>
              </div>
            </div>

            <hr style="border: none; border-top: 1px solid var(--border); margin: 14px 0;" />

            <h3 style="margin: 0 0 10px; font-size: 14px; color:#dbeafe;">Import d’images GeoTIFF</h3>
            <div id="dropzone" class="dropzone" role="button" tabindex="0" aria-label="Déposer vos fichiers GeoTIFF ici">
              Déposez vos fichiers ici ou
              <label for="geotiffInput" class="btn btn-warning" style="margin-left:8px;">Parcourir…</label>
              <input id="geotiffInput" type="file" accept=".tif,.tiff,.geotiff" multiple style="display:none;" />
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
              <span class="muted">Extensions autorisées: .tif, .tiff, .geotiff</span>
              <span id="fileCount" class="badge">0 fichier</span>
              <button id="clearFilesBtn" class="btn" title="Retirer toutes les images de ce projet">Vider la liste</button>
            </div>
            <div id="files" class="files"></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <header>
        <h2 id="modalTitle" style="margin:0;">Nouveau projet</h2>
      </header>
      <div class="panel-body">
        <div style="display:grid; gap:10px;">
          <label>
            <div class="muted" style="margin-bottom:6px;">Nom du projet</div>
            <input id="projectNameInput" class="input" type="text" placeholder="Ex. RN1 - PK 12 à PK 24" />
          </label>
          <label>
            <div class="muted" style="margin-bottom:6px;">Description</div>
            <textarea id="projectDescInput" placeholder="Objectif, zone, phases…"></textarea>
          </label>
        </div>
      </div>
      <footer>
        <button id="cancelCreateBtn" class="btn">Annuler</button>
        <button id="confirmCreateBtn" class="btn btn-primary">Créer</button>
      </footer>
    </div>
  </div>

  <script>
    const storageKey = 'gochantier.projects.v1';
    const emptyProjectsRowHtml = `<tr><td colspan="4" class="empty">Aucun projet. Cliquez sur « Nouveau projet » pour commencer.</td></tr>`;
    const allowedExt = ['.tif', '.tiff', '.geotiff'];

    let projects = [];
    let selectedProjectId = null;

    const el = {
      search: document.getElementById('search'),
      newProjectBtn: document.getElementById('newProjectBtn'),
      projectsBody: document.getElementById('projectsBody'),
      emptyState: document.getElementById('emptyState'),
      detail: document.getElementById('detail'),
      projectName: document.getElementById('projectName'),
      projectMeta: document.getElementById('projectMeta'),
      deleteProjectBtn: document.getElementById('deleteProjectBtn'),
      renameProjectBtn: document.getElementById('renameProjectBtn'),
      dropzone: document.getElementById('dropzone'),
      geotiffInput: document.getElementById('geotiffInput'),
      files: document.getElementById('files'),
      fileCount: document.getElementById('fileCount'),
      clearFilesBtn: document.getElementById('clearFilesBtn'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      projectNameInput: document.getElementById('projectNameInput'),
      projectDescInput: document.getElementById('projectDescInput'),
      cancelCreateBtn: document.getElementById('cancelCreateBtn'),
      confirmCreateBtn: document.getElementById('confirmCreateBtn'),
    };

    function loadProjects() {
      try {
        const raw = localStorage.getItem(storageKey);
        projects = raw ? JSON.parse(raw) : [];
      } catch (_) { projects = []; }
    }

    function saveProjects() {
      localStorage.setItem(storageKey, JSON.stringify(projects));
    }

    function generateId() {
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    function formatDate(date) {
      try { return new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium', timeStyle: 'short' }).format(date); }
      catch (_) { return date.toLocaleString('fr-FR'); }
    }

    function renderProjects(filter = '') {
      const q = filter.trim().toLowerCase();
      const rows = projects
        .filter(p => !q || p.name.toLowerCase().includes(q) || (p.description || '').toLowerCase().includes(q))
        .sort((a,b) => b.createdAt - a.createdAt)
        .map(p => {
          const created = formatDate(new Date(p.createdAt));
          const count = (p.files || []).length;
          const active = p.id === selectedProjectId ? 'style="outline: 2px solid rgba(34,197,94,.35); outline-offset: -2px;"' : '';
          return `<tr data-id="${p.id}" ${active}>
              <td>${escapeHtml(p.name)}</td>
              <td class="muted">${created}</td>
              <td><span class="badge">${count}</span></td>
              <td style="text-align:right;">
                <button class="btn btn-warning btn-open" data-id="${p.id}">Ouvrir</button>
                <button class="btn btn-danger btn-del" data-id="${p.id}">Supprimer</button>
              </td>
            </tr>`;
        });
      el.projectsBody.innerHTML = rows.length ? rows.join('') : emptyProjectsRowHtml;
    }

    function selectProject(id) {
      selectedProjectId = id;
      const project = projects.find(p => p.id === id);
      if (!project) {
        el.detail.style.display = 'none';
        el.emptyState.style.display = '';
        renderProjects(el.search.value);
        return;
      }
      el.projectName.textContent = project.name;
      el.projectMeta.textContent = `${project.description || 'Sans description'} · Créé le ${formatDate(new Date(project.createdAt))}`;
      el.detail.style.display = '';
      el.emptyState.style.display = 'none';
      renderProjects(el.search.value);
      renderFiles();
    }

    function createProject(name, description) {
      const newProject = { id: generateId(), name, description, createdAt: Date.now(), files: [] };
      projects.push(newProject);
      saveProjects();
      renderProjects(el.search.value);
      selectProject(newProject.id);
    }

    function deleteProject(id) {
      const idx = projects.findIndex(p => p.id === id);
      if (idx >= 0) {
        projects.splice(idx, 1);
        if (selectedProjectId === id) selectedProjectId = null;
        saveProjects();
        renderProjects(el.search.value);
        selectProject(selectedProjectId);
      }
    }

    function renameProject(id, newName) {
      const p = projects.find(x => x.id === id);
      if (!p) return;
      p.name = newName;
      saveProjects();
      renderProjects(el.search.value);
      selectProject(id);
    }

    function renderFiles() {
      const project = projects.find(p => p.id === selectedProjectId);
      if (!project) return;
      const list = project.files || [];
      el.fileCount.textContent = `${list.length} ${list.length > 1 ? 'fichiers' : 'fichier'}`;
      if (!list.length) { el.files.innerHTML = ''; return; }
      el.files.innerHTML = list.map((f, i) => `
        <div class="file-item">
          <div class="file-name" title="${escapeHtml(f.name)}">${escapeHtml(f.name)}</div>
          <div style="display:flex; gap:6px; align-items:center;">
            <span class="muted" style="font-size:12px;">${formatBytes(f.size)}</span>
            <button class="btn btn-danger btn-remove-file" data-index="${i}">Retirer</button>
          </div>
        </div>
      `).join('');
    }

    function addFiles(fileList) {
      const project = projects.find(p => p.id === selectedProjectId);
      if (!project || !fileList?.length) return;
      const incoming = Array.from(fileList).filter(file => {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        return allowedExt.includes(ext);
      });
      const normalized = incoming.map(f => ({ name: f.name, size: f.size }));
      project.files = [...(project.files || []), ...normalized];
      saveProjects();
      renderFiles();
      renderProjects(el.search.value);
    }

    function clearFiles() {
      const project = projects.find(p => p.id === selectedProjectId);
      if (!project) return;
      project.files = [];
      saveProjects();
      renderFiles();
      renderProjects(el.search.value);
    }

    function removeFileByIndex(index) {
      const project = projects.find(p => p.id === selectedProjectId);
      if (!project) return;
      project.files.splice(index, 1);
      saveProjects();
      renderFiles();
      renderProjects(el.search.value);
    }

    function escapeHtml(s) {
      return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 o';
      const k = 1024; const sizes = ['o', 'Ko', 'Mo', 'Go', 'To'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return `${(bytes / Math.pow(k, i)).toFixed(1)} ${sizes[i]}`;
    }

    function openModal() { el.modalBackdrop.style.display = 'flex'; el.projectNameInput.focus(); }
    function closeModal() { el.modalBackdrop.style.display = 'none'; el.projectNameInput.value = ''; el.projectDescInput.value = ''; }

    // Event bindings
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (target.classList.contains('btn-open')) selectProject(target.getAttribute('data-id'));
      if (target.classList.contains('btn-del')) {
        const id = target.getAttribute('data-id');
        if (confirm('Supprimer ce projet ? Cette action est définitive.')) deleteProject(id);
      }
      if (target.classList.contains('btn-remove-file')) {
        const idx = Number(target.getAttribute('data-index'));
        removeFileByIndex(idx);
      }
    });

    el.newProjectBtn.addEventListener('click', openModal);
    el.cancelCreateBtn.addEventListener('click', closeModal);
    el.confirmCreateBtn.addEventListener('click', () => {
      const name = el.projectNameInput.value.trim();
      const desc = el.projectDescInput.value.trim();
      if (!name) { alert('Veuillez saisir un nom de projet'); return; }
      createProject(name, desc);
      closeModal();
    });
    el.search.addEventListener('input', () => renderProjects(el.search.value));
    el.deleteProjectBtn.addEventListener('click', () => {
      if (!selectedProjectId) return;
      if (confirm('Supprimer ce projet ?')) deleteProject(selectedProjectId);
    });
    el.renameProjectBtn.addEventListener('click', () => {
      if (!selectedProjectId) return;
      const current = projects.find(p => p.id === selectedProjectId)?.name || '';
      const next = prompt('Nouveau nom du projet :', current);
      if (!next) return;
      renameProject(selectedProjectId, next.trim());
    });

    ;['dragenter','dragover'].forEach(evt => el.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); el.dropzone.classList.add('dragover');
    }));
    ;['dragleave','drop'].forEach(evt => el.dropzone.addEventListener(evt, (e) => {
      e.preventDefault(); e.stopPropagation(); el.dropzone.classList.remove('dragover');
    }));
    el.dropzone.addEventListener('drop', (e) => { if (!selectedProjectId) return; addFiles(e.dataTransfer.files); });
    el.geotiffInput.addEventListener('change', (e) => { if (!selectedProjectId) return; addFiles(e.target.files); e.target.value=''; });
    el.clearFilesBtn.addEventListener('click', clearFiles);

    // Boot
    loadProjects();
    renderProjects();
    selectProject(selectedProjectId);
  </script>
</body>
</html>

