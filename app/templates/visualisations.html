<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visualisations - {{ project.name }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
  <script src="https://unpkg.com/georaster@1.6.0/dist/georaster.browser.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet@3.12.0/dist/georaster-layer-for-leaflet.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.8.1/dist/nouislider.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--accent:#22c55e;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a);color:#e5e7eb}
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    aside{background:rgba(17,24,39,.7);border-right:1px solid rgba(148,163,184,.12);padding:12px;display:grid;align-content:start;gap:10px}
    .project-title{font-weight:700}
    .menu a{display:block;padding:8px 10px;border-radius:8px;color:#e5e7eb;text-decoration:none;border:1px solid rgba(148,163,184,.12);margin-top:4px}
    .menu a.active{border-color:#22c55e}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(17,24,39,.7);border-bottom:1px solid rgba(148,163,184,.12)}
    .content{display:grid;grid-template-rows:auto 1fr;}
    #map{height:calc(100vh - 120px)}
    .toolbar{display:flex;gap:8px;align-items:center;padding:10px}
    .btn{appearance:none;border:1px solid rgba(148,163,184,.18);background:#0b1220;color:#e5e7eb;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:rgba(148,163,184,.35)}
    input[type=date], input[type=file]{background:#0b1220;border:1px solid rgba(148,163,184,.18);color:#e5e7eb;border-radius:10px;padding:8px}
    .label{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;color:#a3e635;background:#1a2e22;border:1px solid #1f7a41;padding:2px 8px;border-radius:999px}
  </style>
</head>
<body>
  <div class="layout">
    <aside>
      <div class="project-title">{{ project.name }}</div>
      <div class="label">{{ project.startDate }} → {{ project.endDate }}</div>
      <div class="menu">
        <a class="active" href="/projets/{{ project.id }}/visualisations">Visualisations</a>
        <a href="/projets/{{ project.id }}/analyse">Analyse</a>
        <a href="/projets/{{ project.id }}/courbes">Rapport courbe</a>
        <a href="/projets/{{ project.id }}/rapports">Rapports</a>
      </div>
    </aside>
    <div>
      <header>
        <div>Visualisations</div>
        <div class="badge" id="progressBadge">{{ project.progress or 0 }}%</div>
      </header>
      <div class="toolbar">
        <input id="fileInput" type="file" accept=".tif,.tiff,.png,.jpg,.jpeg" multiple />
        <input id="dateInput" type="date" />
        <button id="saveDateBtn" class="btn">Affecter la date</button>
        <button id="noteBtn" class="btn">Ajouter commentaire</button>
        <button id="prevBtn" class="btn">⟵ Revenir</button>
        <button id="nextBtn" class="btn">Avancer ⟶</button>
      </div>
      <div id="map"></div>
      <div style="padding:8px 12px" class="label">Molette pour zoomer/dézoomer. Utilisez polyligne/polygone pour les mesures.</div>
    </div>
  </div>

  <script>
    const project = {{ project | tojson }};
    // init map
    const map = L.map('map', { zoomControl: true }).setView([5.35, -4.02], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 22}).addTo(map);
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({ draw: { marker:true, polygon:true, polyline:true, rectangle:true, circle:false, circlemarker:false }, edit:{ featureGroup: drawnItems }});
    map.addControl(drawControl);

    function addNote(){
      const text = prompt('Commentaire:');
      if(!text) return;
      const marker = L.marker(map.getCenter()).addTo(map);
      marker.bindTooltip(text, { permanent: true, direction: 'top' }).openTooltip();
    }
    document.getElementById('noteBtn').addEventListener('click', addNote);

    // timeline list held in memory
    let currentIndex = -1;
    function getDatedImages(){
      return (project.images||[]).filter(i=>!!i.date).sort((a,b)=> new Date(a.date)-new Date(b.date));
    }
    function showIndex(idx){
      const arr = getDatedImages();
      if(!arr.length) return;
      currentIndex = Math.max(0, Math.min(idx, arr.length-1));
      const item = arr[currentIndex];
      // Fit an image layer (raster is not georeferenced here; show marker and popup date)
      // For geotiff, the user can upload and visualize in /suivi module; here show quick reference
      map.eachLayer(l=>{ if(l !== drawnItems && !(l instanceof L.TileLayer)) map.removeLayer(l); });
      const center = map.getCenter();
      const marker = L.marker(center).addTo(map);
      marker.bindPopup(`${item.filename} — ${item.date}`).openPopup();
      document.getElementById('progressBadge').textContent = `${project.progress||0}%`;
    }
    document.getElementById('prevBtn').addEventListener('click', ()=> showIndex(currentIndex-1));
    document.getElementById('nextBtn').addEventListener('click', ()=> showIndex(currentIndex+1));
    showIndex(0);

    // upload images
    document.getElementById('fileInput').addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files||[]);
      if(!files.length) return;
      const form = new FormData();
      // support multiple files with different keys
      files.forEach((f,i)=> form.append(`file${i}`, f));
      const res = await fetch(`/api/projects/${project.id}/images`, { method:'POST', body: form });
      const data = await res.json();
      if(!res.ok){ alert(data.error||'Erreur'); return; }
      project.images = data.project.images;
      project.progress = data.project.progress;
      showIndex(0);
    });

    // set date for last uploaded or selected image (simple: last element)
    document.getElementById('saveDateBtn').addEventListener('click', async ()=>{
      const d = document.getElementById('dateInput').value;
      if(!d){ alert('Choisissez une date'); return; }
      if(!project.images?.length){ alert('Aucune image'); return; }
      const image = project.images[project.images.length-1];
      const res = await fetch(`/api/projects/${project.id}/images/${image.id}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date:d})});
      const data = await res.json();
      if(!res.ok){ alert(data.error||'Erreur'); return; }
      // sync
      const idx = project.images.findIndex(i=> i.id === data.image.id);
      if(idx>=0) project.images[idx] = data.image;
      project.progress = data.project.progress;
      document.getElementById('progressBadge').textContent = `${project.progress||0}%`;
      showIndex(0);
    });
  </script>
</body>
</html>


